<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">

    <title>UI Controller</title>
</head>

<body>
    <ul>
        <li>This UI imitates a logic programming language such as Prolog.</li>
        <li>The map element can be manipulated to update the robot's knowledge of it's environment.</li>
        <li>The robot is controlled using natural language commands, formed from the dropdown constructor.</li>
    </ul>

    <div>
        <form id="actionForm" action="/action" method="POST">
            <select id="select1" name="act" onchange="updateGrammar()">
                <option>Test</option>
                <option>Move</option>
            </select>
            <label for="select1" id="connective">if</label> <!-- "if" / "to" -->
            <select id="select2" name="landmark">
                <option>Landmark 1</option>
                <option>Landmark 2</option>
            </select>
            <label for="select2" id="adjective">is open?</label> <!-- "is open?" / "." -->
            <br><br>
            <input type="submit" value="Send">
        </form>
    </div>

    <ul>
        <li>We can render the ASCII maze used by the A* algorithm (and future, D* Lite) on a JS canvas.</li>
        <li>This could be updated as the robot navigates the environment, to provide feedback.</li>
        <li>The map can also be navigated user arrow keys, to manually set destinations for the robot?</li>
    </ul>

    <pre></pre>
    
    <p>
        <span id="alertSetDest">Coords: </span><span id="coords">1, 1</span>
    </p>
    
    <p>
        <span>Dest: </span><span id="dest"></span>
    </p>

    <script src='https://cdn.jsdelivr.net/gh/jcubic/ascii-canvas/dist/umd.min.js'></script>
    <script src='https://unpkg.com/figlet/lib/figlet.js'></script>
    <script src='https://unpkg.com/js-polyfills/keyboard.js'></script>

    <script>
        function updateGrammar() {
            selectElement = document.getElementById('select1');
            selected = selectElement.value;

            connective = document.getElementById('connective');
            adjective = document.getElementById('adjective');

            if (selected == "1") {
                connective.innerText = "if";
                adjective.innerText = "is open?";
            }
            else if (selected == "2") {
                connective.innerText = "to";
                adjective.innerText = ".";
            }
        }
    </script>

    <script>
        // figlet.js code
        function fonts() {
            return new Promise(resolve => {
                figlet.defaults({
                    fontPath: 'https://cdn.jsdelivr.net/npm/figlet@1.4.0/fonts'
                });
                var fonts = ['Small'];
                figlet.preloadFonts(fonts, resolve);
            });
        }
        function renderFiglet(text) {
            return figlet.textSync(text, {
                font: 'Small'
            }).replace(/\s+$/, '');
        }

        const { Canvas, Item } = canvas;

        let text, height, width, box;

        const ROWS = 18;
        const COLS = 80;
        const myCanvas = new Canvas(COLS, ROWS);

        const rect = new Item(frame());
        myCanvas.append(rect);

        const help = new Item(
            '(?) Use Arrow keys to move. Enter to set dest.',
            { x: 2, y: ROWS - 2 }
        );
        myCanvas.append(help);

        const world = new Item(
            `+----+
|s#  |
|x# #|
|x#e |
|x##x|
| xx |
+----+`,
            { x: 4, y: 4 }
        );
        myCanvas.append(world);

        fonts().then(init);

        function rep(str, count) {
            return new Array(count).fill(str).join('');
        }

        function frame() {
            const output = [];
            const x_count = COLS - 2;
            const y_Count = ROWS - 2;
            output.push(`+${rep('-', x_count)}+`);
            for (let i = 0; i < y_Count; ++i) {
                output.push(`|${rep(' ', x_count)}|`);
            }
            output.push(`+${rep('-', x_count)}+`);
            return output.join('\n');
        }

        function world_item() {
            const world = renderFiglet('World');
            const lines = world.split('\n');
            return new Item(world, {
                x: Math.max(...lines.map(x => COLS - x.length - 1)),
                y: ROWS - lines.length - 1
            });
        }


        function init() {
            box = new Item("*", { x: 1, y: 1 });
            height = 1;
            width = 1;
            myCanvas.append(box);
            
            render();
        }

        // browser code
        var pre = document.getElementsByTagName('pre')[0];
        function render() {
            pre.innerHTML = myCanvas.toString();
        }
        window.addEventListener('keydown', function (e) {
            const { x, y } = box;
            
            switch (e.key) {
                case 'ArrowLeft':
                    if (x > 1) {
                        box.move({ x: x - 1 });
                    }
                    break;
                case 'ArrowRight':
                    if (x + width < COLS - 1) {
                        box.move({ x: x + 1 });
                    }
                    break;
                case 'ArrowUp':
                    if (y-height > 0) {
                        box.move({ y: y - 1 });
                    }
                    break;
                case 'ArrowDown':
                    if (y + height < ROWS - 1) {
                        box.move({ y: y + 1 });
                    }
                    break;
                case 'Enter':
                    document.getElementById('alertSetDest').innerText = 'Set dest to: ';
                    document.getElementById('dest').innerText = box.x + ", " + box.y;
                    setTimeout(() => {
                        document.getElementById('alertSetDest').innerText = 'Coords: ';
                    }, 1000);
                    break
            }

            document.getElementById('coords').innerText = box.x + ", " + box.y;
            
            render();
        });

    </script>
</body>

</html>